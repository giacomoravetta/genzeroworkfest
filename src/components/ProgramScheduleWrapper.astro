---
import ProgramSchedule from "./ProgramSchedule.svelte";
import { getProgramData } from "../lib/notion";

// Disable prerendering to get fresh data on each request
export const prerender = false;

// Get environment variables from Cloudflare runtime or local .env
console.log("ðŸ” Astro.locals.runtime exists:", !!Astro.locals.runtime);
console.log("ðŸ” Astro.locals.runtime.env exists:", !!Astro.locals.runtime?.env);

const env = Astro.locals.runtime?.env;

// Try all possible ways to access env variables
const notionApiKeyFromRuntime = env?.NOTION_API_KEY;
const notionApiKeyFromImportMeta = import.meta.env.NOTION_API_KEY;
const notionDatabaseIdFromRuntime = env?.NOTION_DATABASE_ID;
const notionDatabaseIdFromImportMeta = import.meta.env.NOTION_DATABASE_ID;

console.log("ðŸ”‘ API Key from runtime:", !!notionApiKeyFromRuntime);
console.log("ðŸ”‘ API Key from import.meta.env:", !!notionApiKeyFromImportMeta);
console.log("ðŸ—„ï¸ Database ID from runtime:", !!notionDatabaseIdFromRuntime);
console.log(
    "ðŸ—„ï¸ Database ID from import.meta.env:",
    !!notionDatabaseIdFromImportMeta,
);

const notionApiKey = notionApiKeyFromRuntime || notionApiKeyFromImportMeta;
const notionDatabaseId =
    notionDatabaseIdFromRuntime || notionDatabaseIdFromImportMeta;

console.log("ðŸ”‘ Final API Key available:", !!notionApiKey);
console.log("ðŸ—„ï¸ Final Database ID available:", !!notionDatabaseId);

if (!notionApiKey || !notionDatabaseId) {
    console.error("âŒ Missing environment variables!");
    console.error(
        "Available env keys:",
        env ? Object.keys(env) : "no env object",
    );
    console.error(
        "Available import.meta.env keys:",
        Object.keys(import.meta.env),
    );
}

// Fetch data server-side - pass as separate arguments
const data = await getProgramData(notionApiKey, notionDatabaseId);

console.log("ðŸ“Š Fetched data:", data);
console.log("ðŸ“Š Data length:", data?.length);
console.log("ðŸ“Š Data is array:", Array.isArray(data));
if (data && data.length > 0) {
    console.log("ðŸ“Š First section:", data[0]);
}
---

<section
    class="relative flex flex-col justify-center items-start w-full h-auto px-4 sm:px-6 lg:px-40 pt-8 sm:pt-12 lg:pt-16"
>
    <ProgramSchedule client:only="svelte" {data} />
</section>
